import React from 'react';
import { 
  BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, Cell 
} from 'recharts';
import { Users, HardHat, Home } from 'lucide-react';
import { DISTRICTS_DATA } from '../constants';

interface VulnerabilityAnalysisProps {
  isDarkMode?: boolean;
}

export const VulnerabilityAnalysis: React.FC<VulnerabilityAnalysisProps> = ({ isDarkMode }) => {
  // Transform data for the stacked bar chart
  const chartData = DISTRICTS_DATA.map(d => ({
    name: d.name,
    Elderly: d.vulnerability.elderlyPopulation,
    Workers: d.vulnerability.outdoorWorkers,
    Slum: d.vulnerability.slumPopulation,
    Total: d.vulnerability.elderlyPopulation + d.vulnerability.outdoorWorkers + d.vulnerability.slumPopulation
  })).sort((a, b) => b.Total - a.Total);

  return (
    <div className="h-full flex flex-col gap-6 animate-in fade-in duration-500 overflow-y-auto pr-2">
      
      {/* Aggregate Chart Card */}
      <div className="bg-white dark:bg-zinc-900 p-6 rounded-2xl border border-zinc-200 dark:border-zinc-800 shrink-0">
        <div className="flex justify-between items-center mb-6">
          <h3 className="text-lg font-bold text-zinc-800 dark:text-zinc-100">Regional Vulnerability Index</h3>
          <div className="flex gap-2 text-xs">
             <span className="flex items-center gap-1"><div className="w-2 h-2 rounded-full bg-yellow-500"></div> Elderly</span>
             <span className="flex items-center gap-1"><div className="w-2 h-2 rounded-full bg-red-500"></div> Workers</span>
             <span className="flex items-center gap-1"><div className="w-2 h-2 rounded-full bg-orange-500"></div> Slum</span>
          </div>
        </div>
        <div className="h-64 w-full">
          <ResponsiveContainer width="100%" height="100%">
            <BarChart data={chartData} margin={{ top: 10, right: 10, left: 0, bottom: 0 }} barSize={32}>
              <CartesianGrid strokeDasharray="3 3" vertical={false} stroke={isDarkMode ? "#27272a" : "#f4f4f5"} />
              <XAxis dataKey="name" axisLine={false} tickLine={false} tick={{fill: isDarkMode ? '#a1a1aa' : '#71717a', fontSize: 12, fontWeight: 500}} dy={10} />
              <YAxis axisLine={false} tickLine={false} tick={{fill: isDarkMode ? '#a1a1aa' : '#71717a', fontSize: 12}} />
              <Tooltip 
                cursor={{fill: isDarkMode ? '#18181b' : '#f4f4f5'}}
                contentStyle={{ 
                    backgroundColor: isDarkMode ? '#18181b' : '#fff', 
                    borderColor: isDarkMode ? '#27272a' : '#e4e4e7',
                    color: isDarkMode ? '#fff' : '#000',
                    borderRadius: '8px'
                }}
              />
              <Bar dataKey="Elderly" stackId="a" fill="#eab308" radius={[0, 0, 0, 0]} />
              <Bar dataKey="Workers" stackId="a" fill="#ef4444" />
              <Bar dataKey="Slum" stackId="a" fill="#f97316" radius={[4, 4, 0, 0]} />
            </BarChart>
          </ResponsiveContainer>
        </div>
      </div>

      {/* Detailed Grid */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 pb-4">
        {DISTRICTS_DATA.map((district) => {
           const totalScore = district.vulnerability.elderlyPopulation + district.vulnerability.outdoorWorkers + district.vulnerability.slumPopulation;
           let riskCategory = "Low Risk";
           let riskColor = "bg-zinc-100 text-zinc-700 dark:bg-zinc-800 dark:text-zinc-300";
           
           if (totalScore > 60) {
             riskCategory = "Critical";
             riskColor = "bg-red-500 text-white";
           } else if (totalScore > 40) {
             riskCategory = "High";
             riskColor = "bg-orange-100 text-orange-700 dark:bg-orange-900/40 dark:text-orange-400";
           }

           return (
             <div key={district.id} className="bg-white dark:bg-zinc-900 rounded-2xl shadow-sm border border-zinc-200 dark:border-zinc-800 p-5 hover:border-zinc-300 dark:hover:border-zinc-700 transition-colors group">
               <div className="flex justify-between items-start mb-5">
                 <h3 className="font-bold text-zinc-900 dark:text-white text-lg group-hover:text-red-500 transition-colors">{district.name}</h3>
                 <span className={`text-[10px] uppercase font-bold px-2 py-1 rounded-md tracking-wider ${riskColor}`}>
                   {riskCategory}
                 </span>
               </div>
               
               <div className="space-y-4">
                 {[
                    { icon: Users, label: 'Elderly', val: district.vulnerability.elderlyPopulation, color: 'bg-yellow-500' },
                    { icon: HardHat, label: 'Workers', val: district.vulnerability.outdoorWorkers, color: 'bg-red-500' },
                    { icon: Home, label: 'Slum', val: district.vulnerability.slumPopulation, color: 'bg-orange-500' }
                 ].map((metric, i) => (
                    <div key={i}>
                        <div className="flex justify-between text-xs mb-1.5 text-zinc-500 dark:text-zinc-400 font-medium">
                            <span className="flex items-center gap-1.5"><metric.icon size={12}/> {metric.label}</span>
                            <span>{metric.val}%</span>
                        </div>
                        <div className="w-full bg-zinc-100 dark:bg-zinc-800 h-1.5 rounded-full overflow-hidden">
                            <div className={`${metric.color} h-full rounded-full`} style={{ width: `${metric.val * 2}%` }}></div>
                        </div>
                    </div>
                 ))}
               </div>

               <div className="mt-5 pt-4 border-t border-zinc-100 dark:border-zinc-800 flex items-center justify-between text-xs">
                  <span className="text-zinc-400 font-medium uppercase tracking-wider">Vuln. Index</span>
                  <span className="font-black text-zinc-900 dark:text-white text-lg">{totalScore}</span>
               </div>
             </div>
           );
        })}
      </div>
    </div>
  );
};