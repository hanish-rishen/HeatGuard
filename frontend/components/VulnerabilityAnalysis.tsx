import React from 'react';
import {
  BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, Cell
} from 'recharts';
import { Users, HardHat, Home, TrendingUp } from 'lucide-react';
import { fetchDistricts, DistrictMetadata } from '../services/api';

export const VulnerabilityAnalysis: React.FC = () => {
  const [districts, setDistricts] = React.useState<DistrictMetadata[]>([]);
  const [loading, setLoading] = React.useState(true);

  React.useEffect(() => {
    const loadDistricts = async () => {
      const data = await fetchDistricts();
      setDistricts(data);
      setLoading(false);
    };
    loadDistricts();
  }, []);

  // Transform data for the stacked bar chart
  const chartData = districts.map(d => ({
    name: d.name,
    Elderly: d.vulnerability.elderlyPopulation,
    Workers: d.vulnerability.outdoorWorkers,
    Slum: d.vulnerability.slumPopulation,
    Total: d.vulnerability.elderlyPopulation + d.vulnerability.outdoorWorkers + d.vulnerability.slumPopulation
  })).sort((a, b) => b.Total - a.Total);

  if (loading) {
      return <div className="p-8 text-center text-slate-500">Loading vulnerability data...</div>;
  }

  return (
    <div className="space-y-6 animate-in fade-in duration-500">
      <div className="flex justify-between items-end">
        <div>
           <h2 className="text-xl font-bold text-slate-800">Vulnerability Analysis</h2>
           <p className="text-slate-500">Demographic breakdown of high-risk populations across districts.</p>
        </div>
      </div>

      {/* Aggregate Chart */}
      <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
        <h3 className="text-lg font-semibold text-slate-800 mb-4">Comparative Vulnerability Index</h3>
        <div className="h-80 w-full">
          <ResponsiveContainer width="100%" height="100%">
            <BarChart data={chartData} margin={{ top: 20, right: 30, left: 20, bottom: 5 }}>
              <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e2e8f0" />
              <XAxis dataKey="name" axisLine={false} tickLine={false} tick={{fill: '#64748b', fontSize: 12}} />
              <YAxis axisLine={false} tickLine={false} tick={{fill: '#64748b', fontSize: 12}} label={{ value: '% Population', angle: -90, position: 'insideLeft', fill: '#94a3b8' }}/>
              <Tooltip
                cursor={{fill: '#f1f5f9'}}
                contentStyle={{ borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)' }}
              />
              <Legend iconType="circle" />
              <Bar dataKey="Elderly" stackId="a" fill="#818cf8" radius={[0, 0, 4, 4]} />
              <Bar dataKey="Workers" stackId="a" fill="#f472b6" />
              <Bar dataKey="Slum" stackId="a" fill="#fb923c" radius={[4, 4, 0, 0]} />
            </BarChart>
          </ResponsiveContainer>
        </div>
      </div>

      {/* Detailed Grid */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {districts.map((district) => {
           const totalScore = district.vulnerability.elderlyPopulation + district.vulnerability.outdoorWorkers + district.vulnerability.slumPopulation;
           let riskCategory = "Low Vulnerability";
           let riskColor = "bg-green-100 text-green-700";

           if (totalScore > 60) {
             riskCategory = "Critical Vulnerability";
             riskColor = "bg-red-100 text-red-700";
           } else if (totalScore > 40) {
             riskCategory = "High Vulnerability";
             riskColor = "bg-orange-100 text-orange-700";
           }

           return (
             <div key={district.id} className="bg-white rounded-xl shadow-sm border border-slate-200 p-5 hover:shadow-md transition-shadow">
               <div className="flex justify-between items-start mb-4">
                 <h3 className="font-bold text-slate-800 text-lg">{district.name}</h3>
                 <span className={`text-xs px-2 py-1 rounded-full font-medium ${riskColor}`}>
                   {riskCategory}
                 </span>
               </div>

               <div className="space-y-4">
                 <div>
                   <div className="flex justify-between text-sm mb-1">
                     <span className="flex items-center gap-2 text-slate-600"><Users size={14}/> Elderly</span>
                     <span className="font-semibold text-slate-800">{district.vulnerability.elderlyPopulation}%</span>
                   </div>
                   <div className="w-full bg-slate-100 h-2 rounded-full overflow-hidden">
                     <div className="bg-indigo-400 h-full rounded-full" style={{ width: `${district.vulnerability.elderlyPopulation * 2}%` }}></div>
                   </div>
                 </div>

                 <div>
                   <div className="flex justify-between text-sm mb-1">
                     <span className="flex items-center gap-2 text-slate-600"><HardHat size={14}/> Outdoor Workers</span>
                     <span className="font-semibold text-slate-800">{district.vulnerability.outdoorWorkers}%</span>
                   </div>
                   <div className="w-full bg-slate-100 h-2 rounded-full overflow-hidden">
                     <div className="bg-pink-400 h-full rounded-full" style={{ width: `${district.vulnerability.outdoorWorkers * 2}%` }}></div>
                   </div>
                 </div>

                 <div>
                   <div className="flex justify-between text-sm mb-1">
                     <span className="flex items-center gap-2 text-slate-600"><Home size={14}/> Slum Density</span>
                     <span className="font-semibold text-slate-800">{district.vulnerability.slumPopulation}%</span>
                   </div>
                   <div className="w-full bg-slate-100 h-2 rounded-full overflow-hidden">
                     <div className="bg-orange-400 h-full rounded-full" style={{ width: `${district.vulnerability.slumPopulation * 2}%` }}></div>
                   </div>
                 </div>
               </div>

               <div className="mt-4 pt-4 border-t border-slate-100 flex items-center justify-between text-xs text-slate-500">
                  <span>Combined Index Score</span>
                  <span className="font-bold text-slate-700 text-sm">{totalScore}</span>
               </div>
             </div>
           );
        })}
      </div>
    </div>
  );
};
